{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                –ß–∞—Ç —Å –¥—Ä—É–≥–æ–º
            </div>
            
            <div id="chat-messages" class="card-body bg-light" style="height: 400px; overflow-y: auto;">
                {% for msg in messages %}
                    <div class="mb-3 {% if msg.sender == user %}text-end{% endif %}">
                        <div class="d-inline-block p-2 rounded-3 shadow-sm 
                            {% if msg.sender == user %}bg-primary text-white{% else %}bg-white{% endif %}">
                            {{ msg.text }}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="card-footer bg-white border-0">
                <form id="chat-form" class="d-flex">
                    {% csrf_token %}
                    <input type="text" id="msg-text" class="form-control rounded-pill me-2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ..." required>
                    <button type="button" id="emoji-button" class="btn btn-outline-secondary">üòä</button>
                    <button type="submit" class="btn btn-primary rounded-circle">‚û°Ô∏è</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/emoji-button@latest/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/emoji-button@latest/dist/index.min.js"></script>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase (—Ç–≤–æ–∏ –∫–ª—é—á–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ –∂–µ)
    const supabaseUrl = 'https://pqkdlmpnjkrgbrjehpfd.supabase.co'; 
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; 
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // 1. –°–ú–ê–ô–õ–ò–ö–ò (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫)
    const button = document.querySelector('#emoji-button');
    const input = document.querySelector('#msg-text');
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∏–∫–µ—Ä —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –Ω–µ —Ç–µ—Ä—è–ª—Å—è
    const picker = new EmojiButton({
        position: 'top-start',
        rootElement: document.body // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –æ–∫–Ω–æ —Å–º–∞–π–ª–æ–≤ –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
    });

    picker.on('emoji', selection => {
        input.value += selection;
    });

    button.addEventListener('click', () => {
        picker.togglePicker(button);
    });

    // 2. REALTIME (–û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
    supabaseClient
        .channel('public:core_message')
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'core_message',
            filter: 'room_id=eq.{{ room.id }}' 
        }, (payload) => {
            if (payload.new.sender_id != {{ user.id }}) {
                location.reload(); 
            }
        })
        .subscribe();

    // 3. –û–¢–ü–†–ê–í–ö–ê –ë–ï–ó –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò (–≠—Ç–æ —É—Å–∫–æ—Ä–∏—Ç —Å–∞–π—Ç!)
    const chatForm = document.getElementById('chat-form');
    chatForm.onsubmit = async (e) => {
        e.preventDefault(); // –≠—Ç–æ –æ—Ç–∫–ª—é—á–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É!
        const text = input.value;

        const formData = new FormData();
        formData.append('text', text);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ–Ω–æ–º
        await fetch(window.location.href, {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        });

        input.value = '';
        location.reload(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
    };
</script>
{% endblock %}