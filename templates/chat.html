{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow border-0" style="border-radius: 20px; overflow: hidden;">
            <div class="card-header bg-primary text-white py-3 fw-bold">
                <i class="fas fa-comments"></i> –ß–∞—Ç —Å –¥—Ä—É–≥–æ–º
            </div>
            
            <div id="chat-messages" class="card-body bg-light" style="height: 500px; overflow-y: auto; display: flex; flex-direction: column;">
                {% for msg in messages %}
                    <div class="mb-2 d-flex {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                        <div class="p-2 px-3 shadow-sm" style="max-width: 75%; border-radius: 15px; 
                            {% if msg.sender == user %}
                                background: #6f42c1; color: white; border-bottom-right-radius: 2px;
                            {% else %}
                                background: white; color: #444; border-bottom-left-radius: 2px;
                            {% endif %}">
                            
                            <div class="message-text">{{ msg.text }}</div>
                            
                            <div class="text-end" style="font-size: 0.65rem; opacity: 0.8; margin-top: 2px;">
                                {{ msg.created_at|date:"H:i" }}
                                {% if msg.sender == user %} <i class="fas fa-check-double" style="font-size: 0.6rem;"></i>{% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="card-footer bg-white border-top-0">
                <form id="chat-form" class="d-flex align-items-center">
                    {% csrf_token %}
                    <button type="button" id="emoji-button" class="btn btn-link text-decoration-none fs-4">üòä</button>
                    <input type="text" id="msg-text" class="form-control rounded-pill border-light bg-light px-4 me-2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required autocomplete="off">
                    <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase
    const supabaseUrl = 'https://jxwpehytpxbbnfnadafd.supabase.co'; 
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4d3BlaHl0cHhiYm5mbmFkYWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNDE1NjgsImV4cCI6MjA4MzYxNzU2OH0.llHsbsMFpMBV1VdLou95WwNhO7jmX4NxpwPEv9ibqHY'; 
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const chatMessages = document.getElementById('chat-messages');
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
    const scrollToBottom = () => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };
    scrollToBottom(); // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ä–∞–∑—É –≤–Ω–∏–∑

    // 2. REALTIME (–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
    supabaseClient
        .channel('public:core_message')
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'core_message',
            filter: 'room_id=eq.{{ room.id }}' 
        }, (payload) => {
            // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ —á—É–∂–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —á–∞—Ç
            if (payload.new.sender_id != {{ user.id }}) {
                appendMessage(payload.new.text, false, new Date(payload.new.created_at));
            }
        })
        .subscribe();

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ HTML
    function appendMessage(text, isMe, date) {
        const time = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
        const msgHtml = `
            <div class="mb-2 d-flex ${isMe ? 'justify-content-end' : 'justify-content-start'}">
                <div class="p-2 px-3 shadow-sm" style="max-width: 75%; border-radius: 15px; 
                    ${isMe ? 'background: #6f42c1; color: white; border-bottom-right-radius: 2px;' : 'background: white; color: #444; border-bottom-left-radius: 2px;'}">
                    <div class="message-text">${text}</div>
                    <div class="text-end" style="font-size: 0.65rem; opacity: 0.8; margin-top: 2px;">
                        ${time} ${isMe ? '<i class="fas fa-check-double" style="font-size: 0.6rem;"></i>' : ''}
                    </div>
                </div>
            </div>`;
        chatMessages.insertAdjacentHTML('beforeend', msgHtml);
        scrollToBottom();
    }

    // 3. –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø
    const chatForm = document.getElementById('chat-form');
    const input = document.getElementById('msg-text');

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input.value;
        if(!text) return;

        // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
        appendMessage(text, true, new Date());
        input.value = ''; 

        const formData = new FormData();
        formData.append('text', text);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        await fetch(window.location.href, {
            method: "POST",
            body: formData
        });
    });

    // 4. –°–ú–ê–ô–õ–ò–ö–ò
    document.getElementById('emoji-button').addEventListener('click', () => {
        alert("üí° –ù–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ: –Ω–∞–∂–º–∏—Ç–µ Win + . (—Ç–æ—á–∫–∞)\nüí° –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–º–∞–π–ª—ã –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ.");
    });
</script>
{% endblock %}