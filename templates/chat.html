{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow border-0" style="border-radius: 20px; overflow: hidden; height: 85vh;">
            <div class="card-header bg-primary text-white py-3 d-flex align-items-center">
                <a href="{% url 'home' %}" class="text-white me-3"><i class="fas fa-arrow-left"></i></a>
                <h6 class="mb-0 fw-bold">
                    {% if room.users.count > 2 %}üêæ {{ room.name }}{% else %}–ß–∞—Ç —Å –¥—Ä—É–≥–æ–º{% endif %}
                </h6>
            </div>
            
            <div id="chat-messages" class="card-body" style="background-color: #e5ddd5; background-image: url('https://www.transparenttextures.com/patterns/paws.png'); overflow-y: auto; display: flex; flex-direction: column; padding: 20px;">
                {% for msg in messages %}
                    <div class="mb-2 d-flex {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                        <div class="p-2 px-3 shadow-sm" style="max-width: 75%; border-radius: 12px; 
                            {% if msg.sender == user %}
                                background: #dcf8c6; color: #303030; border-top-right-radius: 2px;
                            {% else %}
                                background: white; color: #303030; border-top-left-radius: 2px;
                            {% endif %}">
                            
                            {% if room.users.count > 2 and msg.sender != user %}
                                <div class="fw-bold text-primary mb-1" style="font-size: 0.75rem;">{{ msg.sender.username }}</div>
                            {% endif %}

                            <div class="message-text">{{ msg.text }}</div>
                            <div class="text-end" style="font-size: 0.6rem; opacity: 0.6; margin-top: 2px;">
                                {{ msg.created_at|date:"H:i" }}
                                {% if msg.sender == user %} <i class="fas fa-check-double text-primary"></i>{% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="card-footer bg-white border-0 py-3">
                <form id="chat-form" class="d-flex align-items-center">
                    {% csrf_token %}
                    <input type="text" id="msg-text" class="form-control rounded-pill border-light bg-light px-4 me-2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required autocomplete="off">
                    <button type="submit" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ—à—å —Å–≤–æ–π —Å–∫—Ä–∏–ø—Ç Supabase, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —Å–∫–∏–¥—ã–≤–∞–ª –≤—ã—à–µ.
    // –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é appendMessage, —á—Ç–æ–±—ã –æ–Ω–∞ –¥–æ–±–∞–≤–ª—è–ª–∞ –∏–º–µ–Ω–∞:
    
    function appendMessage(text, isMe, date, senderName) {
        const time = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
        const showName = !isMe && {{ room.users.count }} > 2;
        
        const msgHtml = `
            <div class="mb-2 d-flex ${isMe ? 'justify-content-end' : 'justify-content-start'}">
                <div class="p-2 px-3 shadow-sm" style="max-width: 75%; border-radius: 12px; 
                    ${isMe ? 'background: #dcf8c6; color: #303030; border-top-right-radius: 2px;' : 'background: white; color: #303030; border-top-left-radius: 2px;'}">
                    ${showName ? `<div class="fw-bold text-primary mb-1" style="font-size: 0.75rem;">–ß—É–∂–æ–π –∫–æ—Ç–∏–∫</div>` : ''}
                    <div class="message-text">${text}</div>
                    <div class="text-end" style="font-size: 0.6rem; opacity: 0.6; margin-top: 2px;">
                        ${time} ${isMe ? '<i class="fas fa-check-double text-primary"></i>' : ''}
                    </div>
                </div>
            </div>`;
        chatMessages.insertAdjacentHTML('beforeend', msgHtml);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
</script>
{% endblock %}