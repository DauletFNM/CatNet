{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    :root {
        --chat-bg-color: #e5ddd5;
        --msg-in-bg: #ffffff;
        --msg-out-bg: #dcf8c6;
        --msg-text-color: #303030;
        --footer-bg: #ffffff;
    }

    body.dark-mode {
        --chat-bg-color: #111b21;
        --msg-in-bg: #202c33;
        --msg-out-bg: #005c4b;
        --msg-text-color: #e9edef;
        --footer-bg: #1a1a1b;
    }

    #chat-messages {
        background-color: var(--chat-bg-color) !important;
        background-image: url('https://www.transparenttextures.com/patterns/paws.png');
        background-attachment: fixed;
        height: 500px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        padding: 20px;
        transition: background-color 0.3s ease;
    }

    .message-bubble {
        max-width: 75%;
        border-radius: 12px;
        padding: 8px 12px;
        color: var(--msg-text-color) !important;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .msg-sent { background-color: var(--msg-out-bg) !important; align-self: flex-end; border-top-right-radius: 2px; }
    .msg-received { background-color: var(--msg-in-bg) !important; align-self: flex-start; border-top-left-radius: 2px; }

    .message-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 5px;
    }

    .message-wrapper.sent {
        flex-direction: row-reverse;
    }

    .msg-deleted {
        opacity: 0.5;
        font-style: italic;
        color: var(--msg-text-color) !important;
    }

    .delete-btn {
        opacity: 0;
        font-size: 0.7rem;
        padding: 2px 4px;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .message-wrapper:hover .delete-btn {
        opacity: 1;
    }

    .card-footer { background-color: var(--footer-bg) !important; }

    
    .btn-send-animate {
        font-family: inherit;
        color: #0e100f;
        background: radial-gradient(129% 99% at 120% 81%, rgb(223, 220, 255) 30%, rgb(166, 158, 255) 100%);
        background-blend-mode: color-dodge;
        font-weight: 600;
        font-size: 14px;
        height: 45px;
        border: none;
        border-radius: 99px;
        padding: 0 25px;
        text-transform: uppercase;
        cursor: pointer;
        min-width: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

   
    #witch-cat-container {
        position: fixed;
        bottom: 20px;
        right: -150px;
        z-index: 10001;
        pointer-events: none;
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow border-0" style="border-radius: 20px; overflow: hidden; height: 85vh;">
            <div class="card-header bg-primary text-white py-3 d-flex align-items-center">
                <a href="{% url 'home' %}" class="text-white me-3"><i class="fas fa-arrow-left"></i></a>
                <h6 class="mb-0 fw-bold">
                    {% if room.users.count > 2 %}üêæ {{ room.name }}{% else %}–ß–∞—Ç —Å –¥—Ä—É–≥–æ–º{% endif %}
                </h6>
            </div>
            
            <div id="chat-messages">
                {% for msg in messages %}
                    {% if not msg.deleted_at %}
                        <div class="mb-2 d-flex {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="message-wrapper {% if msg.sender == user %}sent{% else %}received{% endif %}">
                                <div class="message-bubble {% if msg.sender == user %}msg-sent{% else %}msg-received{% endif %}" data-msg-id="{{ msg.id }}">
                                    {% if room.users.count > 2 and msg.sender != user %}
                                        <div class="fw-bold text-primary mb-1" style="font-size: 0.75rem;">{{ msg.sender.username }}</div>
                                    {% endif %}
                                    <div class="message-text">{{ msg.text }}</div>
                                    <div class="text-end" style="font-size: 0.6rem; opacity: 0.6; margin-top: 2px;">
                                        {{ msg.created_at|date:"H:i" }}
                                        {% if msg.sender == user %} <i class="fas fa-check-double text-primary"></i>{% endif %}
                                    </div>
                                </div>
                                {% if msg.sender == user %}
                                    <button class="btn btn-sm delete-btn text-danger" data-msg-id="{{ msg.id }}" title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="mb-2 d-flex {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %}">
                            <div class="message-bubble msg-deleted {% if msg.sender == user %}msg-sent{% else %}msg-received{% endif %}">
                                <div class="message-text">–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="card-footer py-3">
                <form id="chat-form" class="d-flex align-items-center">
                    {% csrf_token %}
                    <input type="text" id="msg-text" class="form-control rounded-pill px-4 me-2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required autocomplete="off">
                    <button type="submit" id="send-btn" class="btn-send-animate">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    gsap.registerPlugin(TextPlugin);

  
    window.addEventListener('load', () => {
        const witch = document.getElementById('witch-cat-container');
        const tl = gsap.timeline({ repeat: -1, repeatDelay: 10 });

        tl.to(witch, {
            x: -(window.innerWidth + 200), 
            duration: 8, 
            ease: "none"
        });
    });

    
    const sendBtn = document.getElementById('send-btn');
    const btnTL = gsap.timeline({paused:true})
        .to(sendBtn, { duration: 0.5, text: { value: '–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...', type: 'diff' }})
        .to(sendBtn, { duration: 0.4, text: { value: '–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è', type: 'diff' }, repeat: 2, yoyo: true })
        .to(sendBtn, { text: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', ease: 'none' }, "+=0.1")
        .to(sendBtn, { text: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å', delay: 1 });

   
    const supabaseUrl = 'https://jxwpehytpxbbnfnadafd.supabase.co'; 
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4d3BlaHl0cHhiYm5mbmFkYWZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNDE1NjgsImV4cCI6MjA4MzYxNzU2OH0.llHsbsMFpMBV1VdLou95WwNhO7jmX4NxpwPEv9ibqHY'; 
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    const chatMessages = document.getElementById('chat-messages');

    const scrollToBottom = () => { chatMessages.scrollTop = chatMessages.scrollHeight; };
    scrollToBottom();

    supabaseClient.channel('public:core_message').on('postgres_changes', { 
        event: 'INSERT', schema: 'public', table: 'core_message', filter: 'room_id=eq.{{ room.id }}' 
    }, (payload) => {
        if (payload.new.sender_id != {{ user.id }}) appendMessage(payload.new.text, false, new Date(payload.new.created_at));
    }).subscribe();

    function appendMessage(text, isMe, date) {
        const time = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
        const msgHtml = `<div class="mb-2 d-flex ${isMe ? 'justify-content-end' : 'justify-content-start'}">
            <div class="message-bubble ${isMe ? 'msg-sent' : 'msg-received'}">
                <div class="message-text">${text}</div>
                <div class="text-end" style="font-size: 0.6rem; opacity: 0.6;">${time}</div>
            </div></div>`;
        chatMessages.insertAdjacentHTML('beforeend', msgHtml);
        scrollToBottom();
    }

    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('msg-text');
        if(!input.value) return;

        btnTL.play(0); 
        appendMessage(input.value, true, new Date());
        
        const formData = new FormData();
        formData.append('text', input.value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        input.value = '';

        await fetch(window.location.href, { method: "POST", body: formData });
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const msgId = btn.dataset.msgId;
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            
            const response = await fetch(`/delete-message/${msgId}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                const msgBubble = document.querySelector(`[data-msg-id="${msgId}"]`);
                if (msgBubble) {
                    msgBubble.parentElement.parentElement.innerHTML = `
                        <div class="message-bubble msg-deleted msg-sent">
                            <div class="message-text">–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</div>
                        </div>
                    `;
                }
            }
        });
    });
</script>
{% endblock %}
