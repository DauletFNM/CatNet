{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        {% csrf_token %}
        <!-- –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –¥—Ä—É–∑—å—è -->
        {% if pinned_friends %}
        <div class="card shadow-sm border-0 mb-4" style="border-radius: 20px; overflow: hidden;">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold text-warning">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ ({{ pinned_friends.count }})</h5>
            </div>
            
            <div class="list-group list-group-flush">
                {% for pinned in pinned_friends %}
                    <div class="list-group-item py-3 border-0 border-bottom px-4 d-flex justify-content-between align-items-center">
                        <a href="{% url 'start_chat' pinned.friend.id %}" class="d-flex align-items-center text-decoration-none flex-grow-1">
                            <img src="{{ pinned.friend.profile.avatar_url }}" 
                                 alt="{{ pinned.friend.username }}" 
                                 class="rounded-circle me-3 shadow-sm user-avatar-clickable" 
                                 data-user-id="{{ pinned.friend.id }}"
                                 style="width: 55px; height: 55px; object-fit: cover; min-width: 55px; cursor: pointer; transition: transform 0.2s;">
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold text-dark">{{ pinned.friend.username }}</h6>
                                <small class="text-muted">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω</small>
                            </div>
                        </a>
                        <button class="btn btn-sm btn-outline-danger unpin-btn" data-friend-id="{{ pinned.friend.id }}" title="–û—Ç–∫—Ä–µ–ø–∏—Ç—å">
                            ‚úï
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- –ú–æ–∏ —á–∞—Ç—ã -->
        <div class="card shadow-sm border-0" style="border-radius: 20px; overflow: hidden;">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center" style="gap: 10px;">
                <h5 class="mb-0 fw-bold text-primary">–ú–æ–∏ —á–∞—Ç—ã</h5>
                <div class="d-flex gap-2 align-items-center" style="flex-wrap: wrap; justify-content: flex-end;">
                    <a href="{% url 'create_group_chat' %}" class="btn btn-success btn-sm rounded-pill px-3" style="white-space: nowrap; padding: 0.375rem 1rem !important;" title="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç">üêæ –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</a>
                    <a href="{% url 'manage_pinned' %}" class="btn btn-warning btn-sm rounded-pill px-3" style="white-space: nowrap; padding: 0.375rem 1rem !important;" title="–£–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è–º–∏">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è</a>
                    <input type="text" id="chat_search" class="form-control form-control-sm rounded-pill" 
                           placeholder="üîç –ü–æ–∏—Å–∫ —á–∞—Ç–∞..." style="width: 200px; padding: 0.375rem 15px;">
                </div>
            </div>
            
            <div class="list-group list-group-flush">
                {% for room in chatrooms %}
                    <div class="list-group-item py-3 border-0 border-bottom px-4 chat-item" data-chat-name="{% if room.users.count > 2 %}{{ room.name|lower }}{% else %}{% for u in room.users.all %}{% if u != user %}{{ u.username|lower }}{% endif %}{% endfor %}{% endif %}">
                        <a href="{% url 'chat_room' room.id %}" class="text-decoration-none d-flex align-items-center" style="flex-grow: 1;">
                            <div class="d-flex align-items-center flex-grow-1">
                                {% if room.users.count > 2 %}
                                    <div class="rounded-circle bg-gradient d-flex align-items-center justify-content-center text-white me-3 shadow-sm" 
                                         style="width: 55px; height: 55px; background: linear-gradient(135deg, #6f42c1, #a259ff); min-width: 55px;">
                                        <i class="fas fa-users fs-4"></i>
                                    </div>
                                {% else %}
                                    {% for u in room.users.all %}
                                        {% if u != user %}
                                            <img src="{{ u.profile.avatar_url }}" 
                                                 alt="{{ u.username }}" 
                                                 class="rounded-circle me-3 shadow-sm user-avatar-clickable" 
                                                 data-user-id="{{ u.id }}"
                                                 style="width: 55px; height: 55px; object-fit: cover; min-width: 55px; cursor: pointer; transition: transform 0.2s;">
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                
                                <div class="flex-grow-1 overflow-hidden">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <h6 class="mb-0 fw-bold">
                                            {% if room.users.count > 2 %}
                                                üêæ {{ room.name }}
                                            {% else %}
                                                {% for u in room.users.all %}{% if u != user %}{{ u.username }}{% endif %}{% endfor %}
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{% if room.messages.last %}{{ room.messages.last.created_at|date:"H:i" }}{% endif %}</small>
                                    </div>
                                    <div class="text-muted small text-truncate">
                                        {% if room.messages.last %}
                                            <strong>{{ room.messages.last.sender.username }}:</strong> {{ room.messages.last.text }}
                                        {% else %}
                                            <span class="fst-italic text-opacity-50">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                        {% if room.users.count > 2 %}
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                                    onclick="deleteGroupChat({{ room.id }}, '{{ room.name }}')" 
                                    title="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç">
                                üóëÔ∏è
                            </button>
                        {% endif %}
                    </div>
                {% empty %}
                    <div class="p-5 text-center">
                        <p class="text-muted">–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏!</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="limitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">‚ö†Ô∏è –õ–∏–º–∏—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="fs-5 mb-3">–•–æ—á–µ—à—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å –±–æ–ª—å—à–µ –¥—Ä—É–∑–µ–π?</p>
                <p class="mb-2">–°–≤—è–∂–∏—Å—å —Å–æ –º–Ω–æ–π:</p>
                <p class="fw-bold">üìß <a href="mailto:kdaulethtc@gmail.com">kdaulethtc@gmail.com</a></p>
                <p class="text-muted">–∏–ª–∏ –ø–æ Kaspi Gold:</p>
                <p class="fw-bold">üí≥ 4400 4303 1034 3402</p>
                <small class="text-muted d-block mt-3">(—ç—Ç–æ —Ç–∏–ø–æ —à—É—Ç–∫–∞ üòÑ)</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="limitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">‚ö†Ô∏è –õ–∏–º–∏—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="fs-5 mb-3">–•–æ—á–µ—à—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å –±–æ–ª—å—à–µ –¥—Ä—É–∑–µ–π?</p>
                <p class="mb-2">–°–≤—è–∂–∏—Å—å —Å–æ –º–Ω–æ–π:</p>
                <p class="fw-bold">üìß <a href="mailto:kdaulethtc@gmail.com">kdaulethtc@gmail.com</a></p>
                <p class="text-muted">–∏–ª–∏ –ø–æ Kaspi Gold:</p>
                <p class="fw-bold">üí≥ 4400 4303 1034 3402</p>
                <small class="text-muted d-block mt-3">(—ç—Ç–æ —Ç–∏–ø–æ —à—É—Ç–∫–∞ üòÑ)</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
    const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
    
    console.log('CSRF Token:', csrfToken);
    
    function setupUnpinButtons() {
        document.querySelectorAll('.unpin-btn').forEach(btn => {
            btn.addEventListener('click', handleUnpin);
        });
    }
    
    function handleUnpin(e) {
        e.preventDefault();
        e.stopPropagation();
        const friendId = this.dataset.friendId;
        const button = this;
        
        console.log('Unpinning friend:', friendId);
        
        fetch(`/unpin-friend/${friendId}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken}
        }).then(response => {
            console.log('Response status:', response.status);
            return response.json();
        }).then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                // –£–¥–∞–ª–∏—Ç—å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
                button.closest('.list-group-item').remove();
                
                // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π, —Å–∫—Ä—ã—Ç—å –≤–µ—Å—å –±–ª–æ–∫ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö
                const pinnedSection = document.querySelector('.card.shadow-sm.border-0.mb-4');
                if (pinnedSection && !pinnedSection.querySelector('.list-group-item')) {
                    pinnedSection.style.display = 'none';
                }
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–∏');
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞
    function deleteGroupChat(roomId, roomName) {
        if (confirm(`–¢—ã —É–≤–µ—Ä–µ–Ω? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç "${roomName}" —Å–æ –≤—Å–µ–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.`)) {
            fetch(`/delete-group-chat/${roomId}/`, {
                method: 'POST',
                headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞');
            });
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —á–∞—Ç–æ–≤
    const chatSearch = document.getElementById('chat_search');
    if (chatSearch) {
        chatSearch.addEventListener('keyup', function(e) {
            const searchText = this.value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const chatName = item.dataset.chatName || '';
                if (chatName.includes(searchText)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            const visibleItems = Array.from(chatItems).filter(item => item.style.display !== 'none');
            const emptyMsg = document.getElementById('no_results_msg');
            
            if (visibleItems.length === 0 && searchText.length > 0) {
                if (!emptyMsg) {
                    const msg = document.createElement('div');
                    msg.id = 'no_results_msg';
                    msg.className = 'p-5 text-center text-muted';
                    msg.innerHTML = '<p>–ß–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ :(</p>';
                    document.querySelector('.list-group').appendChild(msg);
                }
            } else if (emptyMsg) {
                emptyMsg.remove();
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤ –∏ –∫–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å
    document.querySelectorAll('.user-avatar-clickable').forEach(avatar => {
        avatar.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
        });
        avatar.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
        // –ö–ª–∏–∫ –ø–æ –∞–≤–∞—Ç–∞—Ä—É –≤–µ–¥—ë—Ç –≤ –ø—Ä–æ—Ñ–∏–ª—å
        avatar.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const userId = this.dataset.userId;
            window.location.href = '/user/' + userId + '/';
        });
    });
    
    setupUnpinButtons();
</script>
{% endblock %}